<!DOCTYPE html>
<!--
    Licensed to the Apache Software Foundation (ASF) under one
    or more contributor license agreements.  See the NOTICE file
    distributed with this work for additional information
    regarding copyright ownership.  The ASF licenses this file
    to you under the Apache License, Version 2.0 (the
    "License"); you may not use this file except in compliance
    with the License.  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing,
    software distributed under the License is distributed on an
    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, either express or implied.  See the License for the
    specific language governing permissions and limitations
    under the License.
-->

<html lang="en">
  <head>
    <title>Solace Topic Publisher + Subscriber</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge;" />
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- App styles (dedicated) -->
    <link rel="stylesheet" href="resources/css/styles.css" />

    <!-- Load Solace Web Messaging API for JavaScript -->
    <script defer src="resources/lib/solclient.js"></script>

    <!-- Load the combined pub/sub application logic -->
    <script defer src="resources/scripts/PubSubApp.js"></script>

    <!-- Initialize the app after deferred scripts are loaded -->
    <script>
      window.addEventListener('load', function () {
        if (!window.PubSubApp || typeof window.PubSubApp.init !== 'function') {
          try {
            var logEl = document.getElementById('log');
            if (logEl) {
              logEl.value += '[ERROR] PubSubApp.js did not load or did not initialize correctly.\n' +
                'Check that PubSubApp.js is in the same folder as pubsub.html and that the filename/case matches.\n' +
                'Also check the browser console/network tab for a 404 or script error.\n';
            }
          } catch (e) { /* ignore */ }
          console.error('PubSubApp is not defined. Likely PubSubApp.js failed to load or errored.');
          return;
        }

        window.PubSubApp.init();
      });
    </script>
  </head>

  <body>
    <header class="header">
      <img src="resources/images/solace-logo.png" alt="Solace" class="logo" />
      <h1>Topic Publisher + Subscriber</h1>
    </header>

    <main class="container">

      <!-- Step 1 (starts open) -->
      <details open class="card" id="step1Card">
        <summary>Step 1: Event Broker Connection and Credentials</summary>
        <div class="card-body">
          <div class="form-grid">
            <label for="hosturl">Solace WebSocket URL</label>
            <input id="hosturl" type="text" value="wss://public.messaging.solace.cloud:443" />

            <label for="message-vpn">Message VPN</label>
            <input id="message-vpn" type="text" value="public" />

            <label for="username">Username</label>
            <input id="username" type="text" value="dev-workshop" />

            <label for="password">Password</label>
            <input id="password" type="password" value="password" />
          </div>
        </div>
      </details>

      <!-- Step 2 (starts open) -->
      <details open class="card" id="step2Card">
        <summary>Step 2: Connect to your broker</summary>
        <div class="card-body">
          <p class="section-desc">Connect to establish a session before subscribing or publishing.</p>

          <!-- Inline status/help banner (connection only) -->
          <div id="statusBanner" class="status-banner status-info" role="status" aria-live="polite">
            <div class="status-title" id="statusTitle">Disconnected</div>
            <div class="status-hint" id="statusHint">Enter your broker details in Step 1, then click Connect.</div>
          </div>

          <button type="button" class="ports-btn ports-btn-primary" id="connectToggle">Connect</button>
        </div>
      </details>

      <!-- Step 3 (starts closed) -->
      <details class="card" id="step3Card">
        <summary>Step 3: Subscribe to receive messages</summary>
        <div class="card-body">
          <p class="section-desc">
            Add one or more subscription patterns. The table shows status, plus message counts and last-received time
            (matched in the browser based on topic patterns).
          </p>

          <div class="sub-input-row">
            <div style="flex: 1 1 auto;">
              <label for="subTopic">Subscription Pattern</label>
              <input class="sub-input" id="subTopic" type="text" value="workshop/*" />
            </div>

            <button type="button" class="ports-btn ports-btn-primary sub-btn" id="addSub">Add Subscription</button>
          </div>

          <div id="pubSubSuggestionsLabel"style="margin-top: 0px;">
            <label style="font-weight: 400; font-size: 12px; display: block; margin-bottom: 0px;">Suggested Subscription Patterns:</label>
            <div id="pubSubSuggestions" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
          </div>

          <div id="subsEmptyHint" style="margin-top: 18px;">(No subscriptions yet)</div>

          <table class="subs-table is-hidden" id="subsTable">
            <thead>
              <tr>
                <th>Pattern</th>
                <th>Status</th>
                <th>Msgs</th>
                <th>Last Received</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="subsTbody"></tbody>
          </table>

          <!-- Step 3 specific error/status banner (hidden by default) -->
          <div id="subStatusBanner" class="status-banner status-warn is-hidden section-status" role="status" aria-live="polite">
            <div class="status-title" id="subStatusTitle"></div>
            <div class="status-hint" id="subStatusHint"></div>
          </div>
        </div>
      </details>

      <!-- Step 4 (starts closed) -->
      <details class="card" id="step4Card">
        <summary>Step 4: Publish a message</summary>
        <div class="card-body">
          <div style="display:flex;align-items:center;justify-content:space-between;">
            <p class="section-desc" style="margin:0;">Publish messages to a topic. Subscribers matching the topic will receive them.</p>
            <div class="style-toggle" style="margin-left:12px;">
              <label style="font-weight:600;margin-right:8px;">Topic Taxonomy Style</label>
              <label style="margin-right:6px;"><input type="radio" name="publishStyle" value="basic" checked /> Basic</label>
              <label><input type="radio" name="publishStyle" value="advanced" /> Advanced</label>
            </div>
          </div>

          <!-- Basic mode fields -->
          <div id="basicOptions">
            <div class="form-grid form-grid-single" style="margin-top:10px;">
              <label for="pubTopic">Topic</label>
              <input id="pubTopic" type="text" value="workshop/message" />

              <label for="payload">Payload</label>
              <textarea id="payload" rows="4">Hello World!</textarea>
            </div>
          </div>

          <div id="advancedOptions" class="is-hidden">
            <div style="display:flex;align-items:center;justify-content:space-between;">
              <div style="font-weight:600;">Topic Taxonomy Builder</div>
            </div>

            <div class="form-grid" style="margin-top:10px;grid-template-columns: repeat(7, 1fr);gap:8px;">
              <div>
                <label for="tbDomain">Domain</label>
                <input id="tbDomain" type="text" placeholder="{app-domain}" value="workshop"/>
              </div>
              <div>
                <label for="tbNoun">Noun</label>
                <input id="tbNoun" type="text" placeholder="{data-object}" value="hello-message"/>
              </div>
              <div>
                <label for="tbVerb">Verb</label>
                <input id="tbVerb" type="text" placeholder="{what-happened}" value="announced"/>
              </div>
              <div>
                <label for="tbProp1">Property</label>
                <input id="tbProp1" type="text" placeholder="{metadata-1}" value="united-states" />
              </div>
              <div>
                <label for="tbProp2">Property</label>
                <input id="tbProp2" type="text" placeholder="{metadata-2}" value="en" />
              </div>
              <div>
                <label for="tbProp3">Property</label>
                <input id="tbProp3" type="text" placeholder="{metadata-3}" value="0001" />
              </div>
              <div style="display:flex;align-items:center;justify-content:center;">
                <button type="button" class="ports-btn" id="clearTopicBuilder">Clear All</button>
              </div>
            </div>

            <div class="form-grid form-grid-single" style="margin-top:10px;">
              <label for="generatedTopic">Topic</label>
              <input id="generatedTopic" type="text" />

              <label for="payloadAdvanced">Payload</label>
              <textarea id="payloadAdvanced" rows="9">{
  "eventType": "Hello World Message",
  "eventAction": "Announced",
  "country": "United States",
  "language": "English",
  "sender": "John Doe",
  "timezone": "America/New_York",
  "timestamp": "2024-01-01T00:00:00Z",
  "message": "ðŸ˜Š",
  "msgId": "0001"
}</textarea>
            </div>

            <div class="form-grid form-grid-single" style="margin-top:10px;">
              <label for="advDeliveryMode">Delivery Mode</label>
              <div class="delivery-toggle" id="advDeliveryMode">
                <label style="margin-right:6px;"><input type="radio" name="advDeliveryMode" value="DIRECT" checked /> Direct</label>
                <label><input type="radio" name="advDeliveryMode" value="PERSISTENT" /> Persistent</label>
              </div>
            </div>
          </div>

          <button type="button" class="ports-btn ports-btn-primary" id="publish">Publish Message</button>

          <!-- Step 4 specific error/status banner (hidden by default) -->
          <div id="pubStatusBanner" class="status-banner status-warn is-hidden section-status" role="status" aria-live="polite">
            <div class="status-title" id="pubStatusTitle"></div>
            <div class="status-hint" id="pubStatusHint"></div>
          </div>
        </div>
      </details>

      <!-- Received Messages (starts closed) -->
      <details class="card" id="receivedCard">
        <summary>Received Messages</summary>
        <div class="card-body">
          <textarea id="messages" rows="12" readonly></textarea>
          <div class="below-box-actions">
            <button type="button" class="ports-btn" id="clearMessages">Clear Received Messages</button>
          </div>
        </div>
      </details>

      <!-- Activity Log (starts closed) -->
      <details class="card" id="logCard">
        <summary>Activity Log</summary>
        <div class="card-body">
          <textarea id="log" rows="10" readonly></textarea>
          <div class="below-box-actions">
            <button type="button" class="ports-btn" id="clearLog">Clear Log</button>
          </div>
        </div>
      </details>

    </main>
  </body>
</html>
